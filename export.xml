<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25" zv="Cache for Windows (x86-64) 2017.2 (Build 744U)" ts="2018-05-09 20:49:30">
<Class name="Project.Controller">
<Super>%Persistent,%Populate</Super>
<TimeChanged>64777,74733.551622</TimeChanged>
<TimeCreated>64777,64708.891387</TimeCreated>

<Property name="queries">
<Type>%String</Type>
<Collection>list</Collection>
</Property>

<Method name="addQueryToHistory">
<ClassMethod>1</ClassMethod>
<FormalSpec>query:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  SET q = query
  SET request = "INSERT INTO Project.Query (Request) VALUES (?)"
  SET tStatement = ##class(%SQL.Statement).%New(0,"Sample")
  SET qStatus = tStatement.%Prepare(request)
    IF qStatus'=1 {WRITE "%Prepare failed:" DO $System.Status.DisplayError(qStatus) QUIT}
  SET rtn = tStatement.%Execute(q)
  IF rtn.%SQLCODE=0 {
    WRITE !,"Insert succeeded"
    WRITE !,"Row count=",rtn.%ROWCOUNT
    WRITE !,"Row ID=",rtn.%ROWID }
  ELSEIF rtn.%SQLCODE=-119 {
    WRITE !,"Duplicate record not written",!,rtn.%Message
    QUIT }
  ELSE {
    WRITE !,"Insert failed, SQLCODE=",rtn.%SQLCODE }
    
    RETURN "success"
]]></Implementation>
</Method>

<Method name="getAllQueries">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	SET myquery="SELECT ID, Request FROM Project.Query"
  	SET rset=##class(%ResultSet.SQL).%Prepare(myquery,.err,"")
    WHILE rset.%Next() {
	    WRITE $SYSTEM.SQL.GetROWID()
    WRITE rset.Request,! 
    }
  WRITE "End of data"
  
  return "success"
]]></Implementation>
</Method>

<Method name="deleteQuery">
<ClassMethod>1</ClassMethod>
<FormalSpec>Id:%Integer</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  SET request = "DELETE FROM Project.Query WHERE Id = (?)"
  SET tStatement = ##class(%SQL.Statement).%New(0,"Sample")
  SET qStatus = tStatement.%Prepare(request)
    IF qStatus'=1 {WRITE "%Prepare failed:" DO $System.Status.DisplayError(qStatus) QUIT}
  SET rtn = tStatement.%Execute(Id)
  
  WRITE !,"Row count=",rtn.%ROWCOUNT
  WRITE !,"Row ID=",rtn.%ROWID
  
  RETURN "success"
]]></Implementation>
</Method>

<Method name="runQuery">
<ClassMethod>1</ClassMethod>
<FormalSpec>query:%String</FormalSpec>
<ReturnType>Project.Person</ReturnType>
<Implementation><![CDATA[
		//SET query = "SELECT Name,SecondName, Sex, DateOfBirth FROM Project.Person"
		//SET p = ##class(Project.Controller).runQuery(query)
		
			SET myquery = query
	  		SET tStatement = ##class(%SQL.Statement).%New()
	  		SET qStatus = tStatement.%Prepare(myquery)
	   		IF qStatus'=1 {WRITE "%Prepare failed:" DO $System.Status.DisplayError(qStatus) QUIT}
	  		SET rset = tStatement.%Execute()
	  		DO rset.%Display()
	  		WRITE !,"End of data"
	  		WRITE !, "HISTORY:", Project.Controller.queries
	  		RETURN rset
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^Project.ControllerD</DataLocation>
<DefaultData>ControllerDefaultData</DefaultData>
<IdLocation>^Project.ControllerD</IdLocation>
<IndexLocation>^Project.ControllerI</IndexLocation>
<StreamLocation>^Project.ControllerS</StreamLocation>
<Data name="ControllerDefaultData">
<Value name="1">
<Value>%%CLASSNAME</Value>
</Value>
<Value name="2">
<Value>queries</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="Project.Person">
<SqlTableName>Person</SqlTableName>
<Super>%Persistent,%Populate</Super>
<TimeChanged>64777,65231.677132</TimeChanged>
<TimeCreated>64777,65228.361959</TimeCreated>

<Property name="Name">
<Type>%String</Type>
<Required>1</Required>
<Parameter name="MAXLEN" value="50"/>
</Property>

<Property name="SecondName">
<Type>%String</Type>
<Required>1</Required>
<Parameter name="MAXLEN" value="50"/>
</Property>

<Property name="DateOfBirth">
<Type>%Date</Type>
</Property>

<Property name="Sex">
<Type>%String</Type>
<Parameter name="MAXLEN" value="1"/>
</Property>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^Project.PersonD</DataLocation>
<DefaultData>PersonDefaultData</DefaultData>
<IdLocation>^Project.PersonD</IdLocation>
<IndexLocation>^Project.PersonI</IndexLocation>
<StreamLocation>^Project.PersonS</StreamLocation>
<Data name="PersonDefaultData">
<Structure>listnode</Structure>
<Subscript/>
<Value name="1">
<Value>%%CLASSNAME</Value>
</Value>
<Value name="2">
<Value>Name</Value>
</Value>
<Value name="3">
<Value>SecondName</Value>
</Value>
<Value name="4">
<Value>DateOfBirth</Value>
</Value>
<Value name="5">
<Value>Sex</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="Project.Query">
<SqlTableName>Query</SqlTableName>
<Super>%Persistent</Super>
<TimeChanged>64777,69826.714064</TimeChanged>
<TimeCreated>64777,69755.055201</TimeCreated>

<Property name="Request">
<Type>%String</Type>
<Required>1</Required>
<Parameter name="MAXLEN" value="256"/>
</Property>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^Project.QueryD</DataLocation>
<DefaultData>QueryDefaultData</DefaultData>
<IdLocation>^Project.QueryD</IdLocation>
<IndexLocation>^Project.QueryI</IndexLocation>
<StreamLocation>^Project.QueryS</StreamLocation>
<Data name="QueryDefaultData">
<Structure>listnode</Structure>
<Subscript/>
<Value name="1">
<Value>%%CLASSNAME</Value>
</Value>
<Value name="2">
<Value>Request</Value>
</Value>
</Data>
</Storage>
</Class>
</Export>
